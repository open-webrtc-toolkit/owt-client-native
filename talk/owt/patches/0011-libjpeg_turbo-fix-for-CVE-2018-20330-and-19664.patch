From 93abc4df872f4f9291cf3fce2f5ab471d868fff5 Mon Sep 17 00:00:00 2001
From: Qiu Jianlin <jianlin.qiu@intel.com>
Date: Thu, 19 Sep 2019 11:10:02 +0800
Subject: [PATCH] Apply libjpeg_turbo fix for CVE-2018-20330 & CVE-2018-19664

---
 turbojpeg.c | 7 +++++--
 wrbmp.c     | 3 ++-
 2 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/turbojpeg.c b/turbojpeg.c
index 90a9ce6..b10cdc3 100644
--- a/turbojpeg.c
+++ b/turbojpeg.c
@@ -1960,7 +1960,8 @@ DLLEXPORT unsigned char *tjLoadImage(const char *filename, int *width,
                                      int align, int *height, int *pixelFormat,
                                      int flags)
 {
-  int retval = 0, tempc, pitch;
+  int retval = 0, tempc;
+  size_t pitch;
   tjhandle handle = NULL;
   tjinstance *this;
   j_compress_ptr cinfo = NULL;
@@ -2013,7 +2014,9 @@ DLLEXPORT unsigned char *tjLoadImage(const char *filename, int *width,
   *pixelFormat = cs2pf[cinfo->in_color_space];
 
   pitch = PAD((*width) * tjPixelSize[*pixelFormat], align);
-  if ((dstBuf = (unsigned char *)malloc(pitch * (*height))) == NULL)
+  if ((unsigned long long)pitch * (unsigned long long)(*height) >
+      (unsigned long long)((size_t) - 1) ||
+      (dstBuf = (unsigned char *)malloc(pitch * (*height))) == NULL)
     _throwg("tjLoadImage(): Memory allocation failure");
 
   if (setjmp(this->jerr.setjmp_buffer)) {
diff --git a/wrbmp.c b/wrbmp.c
index 38a64e8..08d18fe 100644
--- a/wrbmp.c
+++ b/wrbmp.c
@@ -506,7 +506,8 @@ jinit_write_bmp(j_decompress_ptr cinfo, boolean is_os2,
       dest->pub.put_pixel_rows = put_gray_rows;
     else
       dest->pub.put_pixel_rows = put_pixel_rows;
-  } else if (cinfo->out_color_space == JCS_RGB565 ||
+  } else if (!cinfo->quantize_colors &&
+             cinfo->out_color_space == JCS_RGB565 ||
              cinfo->out_color_space == JCS_CMYK) {
     dest->pub.put_pixel_rows = put_pixel_rows;
   } else {
-- 
2.21.0.windows.1

